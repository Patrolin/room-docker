<!DOCTYPE html>
<head>
  <script src="shared/qPact.js"></script>
  <script src="shared/black-magic.js"></script>
  <script src="shared/http.js"></script>
  <style>
    body {
      margin: 0;
    }
    body > * {
      width: 100%;
    }
    output {
      white-space: pre;
    }
    button[joinchannel] {
      color: #aaaaaa;
    }
  </style>
  <script>
    const CHANNELS = 0;
    const USERS    = 1;

    class MessageInputComponent extends InputComponent {
      load() {
        this.history = [''];
        this.historyIndex = 0;
      }
      oninput(ev) {
        this.render();
      }
      onkeydown(ev) {
        switch (ev.key) {
          case 'Enter':
            if (this.e.value) {
              this.history[this.history.length - 1] = this.e.value;
              this.historyIndex = this.history.length;
              this.history.push('');
              this.alter();
            }
            break;
          case 'ArrowUp':
            ev.preventDefault();
            var prevHistoryIndex = this.historyIndex;
            if (prevHistoryIndex === this.history.length - 1)
              this.history[this.history.length - 1] = this.e.value;
            this.historyIndex = Math.max(0, this.historyIndex - 1);
            if (this.historyIndex !== prevHistoryIndex) {
              this.e.value = this.history[this.historyIndex];
            }
            break;
          case 'ArrowDown':
            ev.preventDefault();
            var prevHistoryIndex = this.historyIndex;
            this.historyIndex = Math.min(this.historyIndex + 1, this.history.length - 1);
            if (this.historyIndex !== prevHistoryIndex)
              this.e.value = this.history[this.historyIndex];
            break;
        }
      }
      clearMessage() {
        this.e.value = '';
      }
    }
    defineComponent('input[type="text"][msg]', MessageInputComponent);

    class App extends Component {
      initSocket(s) {
        this.s = new WebSocket(`ws://${location.host}/chat`);
        for (var k of this.constructor.socketEvents)
          this.s.addEventListener(k, this[`at${k}`].bind(this));
      }
      load() {
        this.initSocket();
        this.channel = null;
        this.messages = {};

        this.content = this.e.q(/[content]/);
        this.overlay = this.e.q(/[overlay]/);

        this.groups = this.content.q(/div[channels]/);
        this.addgroupButton = this.groups.q(/button[joinchannel]/);
        this.users = this.content.q(/div[users]/);
        this.adduserButton = this.users.q(/button[joinchannel]/);

        this.innercontent = this.content.q(/div[innercontent]/);
        this.output = this.e.q(/.output/);
        this.input = this.e.q(/input[msg]/);

        this.joinchannel = this.e.q(/div[joinchannel]/);
        this.joinchannelInput = this.joinchannel.q(/input[joinchannel]/);
        this.joinchannelInput.onkeydown = (e) => {if(e.key === 'Escape') this.disableJoinChannel()};
        this.joinchannelSelect = this.joinchannel.q(/div[joinchannel]/);

        this.overlayOutput = this.overlay.q(/output/);
      }

      onalter(ev) {
        switch (ev.srcElement) {
          case this.input:
            this.sendMessage(this.input.value);
            this.input.value = '';
            break;
          case this.addgroupButton:
            this.enableJoinChannel(CHANNELS, 'Add a group!');
            break;
          case this.adduserButton:
            this.enableJoinChannel(USERS, 'Add a user!');
            break;
          case this.joinchannelInput:
            this.searchChannel(this.joinchannelInput.table, this.joinchannelInput.value);
            break;
          case this.joinchannelSelect:
            this.disableJoinChannel();
            break;
          default:
            if (ev.srcElement.matches('button[channel]')) {
              this.switchChannel(ev.srcElement);
            } else if (ev.srcElement.matches('button[joinchannel]')) {
              this.joinChannel(ev.srcElement.uuid);
            }
        }
      }

      atopen(ev) {
        this.content.removeAttribute('blur');
        this.overlay.setAttribute('disabled', '');
        this.s.send('{"type": "hello"}');
      }
      atclose(ev) {
        this.content.setAttribute('blur', '');
        this.overlay.removeAttribute('disabled');
        this.overlayOutput.value = 'Connection lost';
        this.overlay.parentNode.c.render();
        setTimeout(this.initSocket.bind(this), 5000);
      }
      aterror(ev) {
        console.log(ev);
      }

      atmessage(ev) {
        var out = JSON.parse(ev.data);
        console.log(out);
        switch (out.type) {
          case 'hello':
            this.groups.Q();
            for (var uuid in out.msg) {
              var x = out.msg[uuid];
              if (x.table === CHANNELS) {
                this.groups.q(`<button channel>${x.name}`).uuid = uuid;
              }
            }
            this.addgroupButton = this.groups.q('<button joinchannel>+');
            pactInit(this.groups);
            this.groups.c.render();

            this.users.Q();
            for (var uuid in out.msg) {
              var x = out.msg[uuid];
              if (x.table === USERS) {
                this.users.q(`<button channel>${x.name}`).uuid = uuid;
              }
            }
            this.adduserButton = this.users.q('<button joinchannel>+');
            pactInit(this.users);
            this.users.c.render();
            break;
          case 'search':
            this.joinchannelSelect.Q();
            for(var x of out.msg){
              this.joinchannelSelect.q(`<button joinchannel>${x.name}`).uuid = x.uuid;
            }
            pactInit(this.joinchannelSelect);
            this.joinchannelSelect.c.render();
            break;
          // TODO(Patrolin): implement status
          case 'msg':
            this.drawMessage(out);
            break;
          case 'reload':
            this.output.Q();
            for(var row of Object.values(out.msg))
              console.log(row), this.drawMessage(row);
            break;
        }
      }

      enableJoinChannel(table, placeholder){
        this.joinchannelInput.table = table;
        this.joinchannelInput.placeholder = placeholder;
        this.joinchannel.c.disabled = false;
        this.joinchannel.q(/input/).focus();
        this.render();
        this.searchChannel(this.joinchannelInput.table, this.joinchannelInput.value);
      }
      disableJoinChannel(){
        this.joinchannel.c.disabled = true;
        this.joinchannel.q(/input/).blur();
        this.joinchannelInput.value = '';
        this.joinchannelSelect.Q();
        this.render();
      }
      searchChannel(table, name){
        this.s.send(`{"type": "search", "table": "${table}", "msg": "${name}"}`);
      }
      joinChannel(channel){
        this.s.send(`{"type": "join", "msg": ${channel}}`);
      }

      switchChannel(channel){
        if (this.channel !== null) this.channel.removeAttribute('bold');
        this.channel = channel;
        this.channel.setAttribute('bold', '');
        this.innercontent.c.disabled = false;
        this.render();
        this.s.send(`{"type": "reload", "msg": "${channel.uuid}"}`);
      }
      sendMessage(value) {
        if(this.channel === null) {
          this.input.value = value;
          return;
        }
        this.output.value += `${value}\n`;
        this.output.c.render();
        this.output.c.scroll = this.output.c.scrollMax;

        this.s.send(JSON.stringify({
          type: "msg",
          B: this.channel.uuid,
          msg: value,
        }));
      }
      drawMessage(out) {
        if(this.channel !== null && out.B === this.channel.uuid){
          var e = q(out.msg);
          var d = e.constructor === Text ? q('<text>') : q('<p>');
          d.q(e);
          this.output.append(d);
          pactInit(d);
          this.output.c.render();
          this.output.c.scroll = this.output.c.scrollMax;
        }
      }
    }
    App.socketEvents = getEvents(App, 'at');
    defineComponent('app', App);
  </script>
</head>
<body id="body">
  <app>
    <stack>
      <row content blur>
        <div channels f="0.1" width="79" cHeight="64" nopadding>
          <button joinchannel>+</button>
        </div>
        <div users f="0.1" width="79" cHeight="64" nopadding>
          <button joinchannel>+</button>
        </div>
        <div innercontent nopadding disabled>
          <div class="output" cHeight="32"></div>
          <input f="0.1" type="text" msg placeholder="Send a message!" />
        </div>
      </row>
      <div overlay padding>
        <output>Connecting<br />to server</output>
      </div>
      <div joinchannel nopadding disabled>
        <input joinchannel f="0.1" placeholder="Add a channel!" />
        <div joinchannel cHeight="32" onclick="this.c.alter()">
      </div>
    </stack>
  </app>
</body>
