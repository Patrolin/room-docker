<!DOCTYPE html>
<head>
  <script src="shared/qPact.js"></script>
  <script src="shared/black-magic.js"></script>
  <script src="shared/http.js"></script>
  <style>
    body {
      margin: 0;
    }
    body > * {
      width: 100%;
    }
    output {
      white-space: pre;
    }
  </style>
  <script>
    class MessageInputComponent extends InputComponent {
      load() {
        this.history = [''];
        this.historyIndex = 0;
      }
      oninput(ev) {
        this.render();
      }
      onkeydown(ev) {
        switch (ev.key) {
          case 'Enter':
            if (this.e.value) {
              this.history[this.history.length - 1] = this.e.value;
              this.historyIndex = this.history.length;
              this.history.push('');
              this.alter();
            }
            break;
          case 'ArrowUp':
            ev.preventDefault();
            var prevHistoryIndex = this.historyIndex;
            if (prevHistoryIndex === this.history.length - 1)
              this.history[this.history.length - 1] = this.e.value;
            this.historyIndex = Math.max(0, this.historyIndex - 1);
            if (this.historyIndex !== prevHistoryIndex) {
              this.e.value = this.history[this.historyIndex];
            }
            break;
          case 'ArrowDown':
            ev.preventDefault();
            var prevHistoryIndex = this.historyIndex;
            this.historyIndex = Math.min(this.historyIndex + 1, this.history.length - 1);
            if (this.historyIndex !== prevHistoryIndex)
              this.e.value = this.history[this.historyIndex];
            break;
        }
      }
      clearMessage() {
        this.e.value = '';
      }
    }
    defineComponent('input[type="text"][msg]', MessageInputComponent);

    class App extends Component {
      initSocket(s) {
        this.s = new WebSocket(`ws://${location.host}/chat`);
        for (var k of this.constructor.socketEvents)
          this.s.addEventListener(k, this[`at${k}`].bind(this));
      }
      load() {
        this.initSocket();
        this.receiveQueue = [];
        this.sendQueue = [];
        this.sendInterval = null;

        [this.content, this.overlay] = this.e.q(/stack/).children;
        this.output = this.e.q(/.output/);
        this.input = this.e.q(/input[msg]/);

        this.overlayOutput = this.overlay.q(/output/);
      }

      atopen(ev) {
        this.content.removeAttribute('blur');
        this.overlay.setAttribute('disabled', '');
      }
      atclose(ev) {
        this.content.setAttribute('blur', '');
        this.overlay.removeAttribute('disabled');
        this.overlayOutput.value = 'Connection lost';
        this.overlay.parentNode.c.render();
        setTimeout(this.initSocket.bind(this), 5000);
      }
      aterror(ev) {
        console.log(ev);
      }

      atmessage(ev) {
        console.log(ev.data);
        for (var line of ev.data.split('\n')) this.drawMessage(line);
        this.output.c.render();
        this.output.c.scroll = this.output.c.scrollMax;
      }
      drawMessage(value) {
        if (value) {
          var e = q(value);
          var d = e.constructor === Text ? q('<text>') : q('<p>');
          d.q(e);
          this.output.append(d);
          pactInit(d);
        }
      }

      onalter(ev) {
        if (ev.srcElement === this.input) {
          this.sendMessage(this.input.value);
          this.input.value = '';
        }
      }
      sendMessage(value) {
        this.drawMessage(value);
        this.output.value += `${value}\n`;
        this.output.c.render();
        this.output.c.scroll = this.output.c.scrollMax;

        this.sendQueue.push(value);
        if (this.sendInterval === null && this.s.readyState)
          this.sendInterval = window.setInterval(this.sendQueued.bind(this), 50);
      }
      sendQueued() {
        var value = this.sendQueue.pop(0);
        if (value) this.s.send(value);
        else {
          window.clearInterval(this.sendInterval);
          this.sendInterval = null;
        }
      }
    }
    App.socketEvents = getEvents(App, 'at');
    defineComponent('app', App);
  </script>
</head>
<body id="body">
  <app>
    <stack>
      <row blur>
        <div f="0.1" width="79" cHeight="64" nopadding>
          <text><i>Doupě</i></text>
          <text>LRWCP</text>
          <text
            ><b>Pat's<br />Room</b></text
          >
        </div>
        <div f="0.1" width="79" cHeight="64" nopadding>
          <text>Groowy</text>
          <text>raden</text>
          <text>Majkyz</text>
          <text>Interpreter</text>
          <text>Poky</text>
          <text>Váš<br />Wojciech</text>
          <text>Pavel<br />Raiter</text>
          <text>roudnas</text>
          <text>Ejdrien</text>
          <text>Ulambula</text>
          <text>maty139cz</text>
          <text>Kitcat</text>
          <text>Morkalb</text>
          <text>Terablix</text>
          <text>Nonemara</text>
        </div>
        <div nopadding>
          <div class="output" cHeight="32"></div>
          <input f="0.1" type="text" msg placeholder="Send a message!" />
        </div>
      </row>
      <div padding>
        <output>Connecting<br />to server</output>
      </div>
    </stack>
  </app>
</body>
